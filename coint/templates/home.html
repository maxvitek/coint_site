{% load staticfiles %}
{% load tz %}
<!doctype html>
<head>
    <style>
        @import url(//fonts.googleapis.com/css?family=Yanone+Kaffeesatz:400,700);
    </style>
    <link type="text/css" rel="stylesheet" href="{% static "style.css" %}">
    <link type="text/css" rel="stylesheet" href="{% static "rickshaw.css" %}">
    <title>Cointegration Demonstration</title>
    <script src="{% static "d3.v3.js" %}"></script>
    <script src="{% static "rickshaw.js" %}"></script>
</head>
<body>
    <h2>Cointegration Demonstration</h2>
    <p>This is some text that will appear in a place very like this.</p>
    <div id="pairs"></div>
    <div id="chart"></div>

    <script>

    function name(d) { return d.name; }
    function group(d) { return d.group; }

    var color = d3.scale.category10();
    function colorByGroup(d) { return color(group(d)); }

    var width = 960,
        height = 500;

    var svg = d3.select('#pairs')
        .append('svg')
        .attr('width', width)
        .attr('height', height);

    var node, link;

    var voronoi = d3.geom.voronoi()
        .x(function(d) { return d.x; })
        .y(function(d) { return d.y; })
        .clipExtent([[-10, -10], [width+10, height+10]]);

    function recenterVoronoi(nodes) {
        var shapes = [];
        voronoi(nodes).forEach(function(d) {
            if ( !d.length ) return;
            var n = [];
            d.forEach(function(c){
                n.push([ c[0] - d.point.x, c[1] - d.point.y ]);
            });
            n.point = d.point;
            shapes.push(n);
        });
        return shapes;
    }

    var force = d3.layout.force()
        .charge(-2000)
        .friction(0.3)
        .linkDistance(50)
        .size([width, height]);

    force.on('tick', function() {
        node.attr('transform', function(d) { return 'translate('+d.x+','+d.y+')'; })
            .attr('clip-path', function(d) { return 'url(#clip-'+d.index+')'; });

        link.attr('x1', function(d) { return d.source.x; })
            .attr('y1', function(d) { return d.source.y; })
            .attr('x2', function(d) { return d.target.x; })
            .attr('y2', function(d) { return d.target.y; });

        var clip = svg.selectAll('.clip')
            .data( recenterVoronoi(node.data()), function(d) { return d.point.index; } );

        clip.enter().append('clipPath')
            .attr('id', function(d) { return 'clip-'+d.point.index; })
            .attr('class', 'clip');
        clip.exit().remove()

        clip.selectAll('path').remove();
        clip.append('path')
            .attr('d', function(d) { return 'M'+d.join(',')+'Z'; });
    });

    var data = {{ nodes|safe }}

    data.nodes.forEach(function(d, i) {
        d.id = i;
    });

    link = svg.selectAll('.link')
        .data( data.links )
      .enter().append('line')
        .attr('class', 'link')
        .style("stroke-width", function(d) { return Math.sqrt(d.value); });

    node = svg.selectAll('.node')
        .data( data.nodes )
      .enter().append('g')
        .attr('title', name)
        .attr('class', 'node')
        .call( force.drag );

    node.append('circle')
        .attr('r', 30)
        .attr('fill', colorByGroup)
        .attr('fill-opacity', 0.5);

    node.append('circle')
        .attr('r', 4)
        .attr('stroke', 'black');

    force
        .nodes( data.nodes )
        .links( data.links )
        .start();

    </script>

    <script>

    var series1 = [{% for i in data %}{ x: {{ i.datetime }}, y: {{ i.ticker1 }} }{% if not forloop.last %},{% endif %}{% endfor %}];

    var series2 = [{% for i in data %}{ x: {{ i.datetime }}, y: {{ i.ticker2 }} }{% if not forloop.last %},{% endif %}{% endfor %}];

    var min1 = Number.MAX_VALUE;
    var max1 = Number.MIN_VALUE;
    for (i = 0; i < series1.length; i++) {
      min1 = Math.min(min1, series1[i].y);
      max1 = Math.max(max1, series1[i].y);
    }

    var min2 = Number.MAX_VALUE;
    var max2 = Number.MIN_VALUE;
    for (i = 0; i < series2.length; i++) {
      min2 = Math.min(min2, series2[i].y);
      max2 = Math.max(max2, series2[i].y);
    }

    var axis1 = d3.scale.linear().domain([min1, max1]);
    var axis2 = d3.scale.linear().domain([min2, max2]);

    var graph = new Rickshaw.Graph( {
        element: document.getElementById("chart"),
        width: 750,
        height: 250,
        renderer: 'line',
        series: [
            {
                color: "#ff9030",
                data: series1,
                name: "{{ ticker1 }}",
                scale: axis1
            }, {
                color: "#ff4040",
                data: series2,
                name: "{{ ticker2 }}",
                scale: axis2
            }
        ]
    } );

    //graph.renderer.dotSize = 2;

    new Rickshaw.Graph.HoverDetail({ graph: graph });

    graph.render();

    </script>
</body>
